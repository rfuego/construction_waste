# Stable Diffusion Application using React with FastAPI


Hello, I would like to share with you this small project that involves creating an Stable Diffusion App with React and FastAPI :grin:. 


Let's dive in by introducing what is the project about and why I have done it. 

## 1. What is this project about? 

ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Fuego Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð¸ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ð²Ð¸Ð´Ð¾Ð² Ð¾Ñ‚Ñ…Ð¾Ð´Ð¾Ð² ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð° Ð¸ ÑÐ½Ð¾ÑÐ°. Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð° Ð¼Ð¾Ð´ÐµÐ»ÑŒ YOLOv8, Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð½Ð°Ñ Ð½Ð° Ð´Ð°Ñ‚Ð°ÑÐµÑ‚Ðµ, ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð² ÑÐµÑ€Ð²Ð¸ÑÐµ Roboflow, Ð¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð¾Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð½Ð°Ñ Ð½Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ñ ÐºÐ°Ð¼ÐµÑ€ Ð²Ð¸Ð´ÐµÐ¾Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ.

Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ…Ð¾Ð´Ñ‹ ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¼ÑƒÑÐ¾Ñ€Ð° Ð¸ ÑÐ½Ð¾ÑÐ° Ð² ÐºÑƒÐ·Ð¾Ð²Ðµ ÑÐ¿ÐµÑ†Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸, Ð¸ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¼ÐµÐ½Ñƒ Ð·Ð°ÑÐ²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑƒÐºÐ°Ð·Ð°Ð½ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹ Ð² Ñ€ÐµÐ¹Ñ.

## 2. Why I did built it?

For the past couple of months I've been hearing a lot about Stable Diffusion but I haven't had the time to explore it myself, then I saw an opportunity to get to know it but also do a refresh on my frontend skills which were a bit out-of-date by building a React App. 

Additionally, I wanted to learn more about FastAPI and this project is built on top of the webinar provided by the author of the library [Sebastian Ramirez](https://github.com/tiangolo). 

## 3. Concepts 

Before diving into the project, I'll give you an overview of the main concepts and technologies that have been used, and pointers to resources where you can learn more about it. 

### 3.1 React as Front-end 

React ÐºÐ°Ðº Front-end 

Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð²Ñ‹ ÑƒÐ¶Ðµ ÑÐ»Ñ‹ÑˆÐ°Ð»Ð¸ Ð¾ React, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ€Ð°Ð·Ð´ÐµÐ», ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð½Ðµ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¸Ð·Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾ React. 

[[React](https://reactos.org/) - Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° JavaScript Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°. ÐžÐ½ Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Facebook (Ð¾Ð½ Ð¶Ðµ Meta) Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ Ð² 2013 Ð³Ð¾Ð´Ñƒ. 

ÐÐ°ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ ÑÐ¼Ð¾Ð³ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½Ð°Ð´ ÑÑ‚Ð¸Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð¼, React Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´ÐµÐºÐ»Ð°Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾, Ð¸ Ð¾Ð´Ð½Ð° Ð¸Ð· Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚ÐµÐ¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð´ÐµÐ»Ð°ÐµÑ‚ ÐµÐ³Ð¾ ÐºÐ»Ð°ÑÑÐ½Ñ‹Ð¼, Ð·Ð°ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ð² Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸Ð¼ÐµÑŽÑ‚ ÑÐ²Ð¾Ðµ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ, Ð¸ Ð¿Ð¾Ð·Ð¶Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ñ‹ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ‹ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚Ðµ. 

Ð˜ÑÑ…Ð¾Ð´Ñ Ð¸Ð· Ñ‡Ð¸ÑÑ‚Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð½Ð¾Ð³Ð¾ Ð¾Ð¿Ñ‹Ñ‚Ð°, Ñ Ð¼Ð¾Ð³Ñƒ ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº ÑƒÐ¶ ÑÐ»Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ñ‚Ð¾, Ñ‡ÐµÐ³Ð¾ Ñ Ñ…Ð¾Ñ‚ÐµÐ» Ð´Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ, Ð° Ð¸Ð¼ÐµÐ½Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ñ‚ Ð¼Ð½Ðµ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚ Ð¸ Ð¶Ð´Ð°Ñ‚ÑŒ, Ð¿Ð¾ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ.


[React](https://reactjs.org/) is a JavaScript library for building UI. 
#### 3.2.1 Resources
- [React Docs](https://reactjs.org/docs/getting-started.html)

### 3.3 FastAPI as backend

In here, things become more interesting to me when backend comes in and I discovered all you can do working with FastAPI. 

As their website state: 
> FastAPI is a modern, fast (high-performance), web framework for building APIs with Python 3.7+ based on standard Python type hints.

What I like from FastAPI is the ability to create API's quickly without too much hassle. I loved the fact I could define the routes and immediately check them out by looking at the API docs provided by Swaggeer. 

Additionally to this, you could define your data model as a Class by using pydantic inheriting from BaseModel. 

#### 3.3.1 Resources
- [FastAPI Docs](https://fastapi.tiangolo.com/)
- [FastAPI Tutorial - User Guide](https://fastapi.tiangolo.com/tutorial/)

## Project Structure

```
â”œâ”€â”€ backend                          ----> Contains all the backend FastAPI work
â”‚Â Â  â”œâ”€â”€ dev-requirements.txt
â”‚Â Â  â”œâ”€â”€ main.py                      ----> Endpoints definition
â”‚Â Â  â”œâ”€â”€ requirements.txt
â”‚Â Â  â”œâ”€â”€ run_uvicorn.py
â”‚Â Â  â”œâ”€â”€ schemas.py                   ----> Define your data models here
â”‚Â Â  â””â”€â”€ services.py                  ----> Define all the heavy load work to be done here.
|                                          in this case all the HuggingFace setup and work for generating the 
|                                          stable diffusion image
â””â”€â”€ frontend
    â”œâ”€â”€ README.md
    â”œâ”€â”€ package-lock.json
    â”œâ”€â”€ package.json
    â”œâ”€â”€ public
    â”‚Â Â  â”œâ”€â”€ index.html
    â”‚Â Â  â”œâ”€â”€ manifest.json
    â”‚Â Â  â””â”€â”€ robots.txt
    â””â”€â”€ src
        â”œâ”€â”€ App.jsx                 ---> Main App definition where you will embed your components as well
        â”œâ”€â”€ components
        â”‚Â Â  â”œâ”€â”€ ErrorMessage.jsx
        â”‚Â Â  â”œâ”€â”€ GenImage.jsx        ---> Definition of the UI components as well as the call to the backend 
                                         using fetch API
        â”‚Â Â  â””â”€â”€ Header.jsx          ---> Minimal Header definition
        â””â”€â”€ index.js
```

## Setup and run it :) 

These are the steps to see it running :) 

### From your backend folder: 

1. You need a HugginFace token. Checkout how to create one [here](https://huggingface.co/docs/hub/security-tokens#how-to-manage-user-access-tokens)
2. Once you have your token created it follow the next steps

```
cd backend 
touch .env 
```

3. Open the .env file and add your token there like this: 

```
HF_TOKEN=MY_FANCY_TOKEN
```

**WARNING**: Make sure you never commit your keys or tokens file :) Add this file to your .gitignore

4. Create your environment and activate your environment
```
python -m venv venv 
source venv/bin/activate
pip install -r requirements.txt
```

5. Startup your backend 

```
uvicorn main:app --port 8885
```

### From your frontend folder

```
cd frontend
npm install 
npm start
```

## How to Generate an Image? 

Fill the parameters as follows:

- Prompt: Text to express the wish for your image. 

    `Example: A red racing car winning the formula-1` 
- Seed: a number indicating the seed so that your output will be deterministic. 
- Guidance scale: it's a float that basically try to enforce that the generation of the image better match the prompt. 

    > Side note: if you are curious about this parameter, you can do a deep dive by reading the paper [Classifier-free Diffusion Guidance](https://arxiv.org/pdf/2207.12598.pdf)
- Number of Inference Steps: It's a number usually between 50 and 100. This number indicates de amount of denoising steps. Keep in mind the higher the number the more time the inference ( image generation ) will take. 

You should be able to see your frontend like this one below: 

<p align="center">
<img src="./assets/demo.png" alt="Demo example" width=700 height=400 />
</p>

## Resources I've used to build the project

- Webinar: [FastAPI for Machine Learning: Live coding an ML web application](https://www.youtube.com/watch?v=_BZGtifh_gw)
- FastAPI and ReactJS, a set of videos by [Rithmic - Youtube Channel](https://youtube.com/playlist?list=PLhH3UpV2flrwfJ2aSwn8MkCKz9VzO-1P4)
- [Stable Diffusion with ðŸ§¨ Diffusers by HuggingFace](https://huggingface.co/blog/stable_diffusion)

## ToDo

- Add endpoint that shows a grid of images instead of one
- Update the service backend with a new function to return multiple images. 
- Improve the UI by customizing Bulma with a different style. 
